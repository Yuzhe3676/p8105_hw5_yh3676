---
title: "p8105_hw5_yh3676"
author: "Yuzhe Hu"
date: "2023-11-15"
output: github_document
latex_engine: xelatex
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(broom)
library(purrr)
library(viridis)
set.seed(1)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 10, 
  fig.height = 8,
	dpi = 800,
  out.width = "90%"
)

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

## Problem 2

Create a tidy dataframe containing data from all participants.

```{r,message=FALSE}
# read all dataframes
combined_df = 
  tibble(
    files = list.files("./data/problem2/"),
    path = str_c("./data/problem2/", files)
  ) |>
  mutate(data = map(path, read_csv)) |>
  unnest()

# tidy the result
tidy_df = 
  combined_df |>
  mutate(
    files = str_replace(files, ".csv", ""),
    arm = str_sub(files, 1, 3),
    subject_id = str_sub(files, 5, 7)) |>
  pivot_longer(
    week_1:week_8,
    names_to = "week",
    values_to = "value",
    names_prefix = "week_") |>
  mutate(week = as.numeric(week)) |>
  select(arm, subject_id, week, value)
```

Make a spaghetti plot showing observations on each subject over time.
```{r}
tidy_df |>
  ggplot(aes(x = week, y = value, color = subject_id)) +
  geom_line() +
  geom_point() + 
  facet_grid(~arm) +
  labs(x = 'Week', y = 'Value', title = 'Spaghetti plot on each subject over time')
```

* From the spaghetti plot, the values of the 10 participants in the experimental arm has an increasing trend over 8 weeks. In contrast, the values of the 10 participants in the control arm do not have this trend.


## Problem 3

Simulate for `μ = 0`

```{r}
t_test = function(mu){
  sim_data = tibble(
    rnorm(n = 30, mean = mu, sd = 5)) 
  
  t_test_result = 
    t.test(sim_data) |>
    broom::tidy() |>
    select(estimate, p.value)
  
  return(t_test_result)
}
  
mu_0 =
  tibble(
    mu = 0,
    iteration = 1:5000
  ) |>
  mutate(t_test_df = map(mu, t_test)) |>
  unnest(t_test_df)
```

Simulate for `μ={1,2,3,4,5,6}`

```{r}
multimu_result =
  expand_grid(mu = 1:6, iteration = 1:5000) |>
  mutate(multimu_df = map(mu, t_test)) |>
  unnest(multimu_df)
```

A plot showing the proportion of times the null was rejected.

```{r}
result = bind_rows(mu_0, multimu_result)
result |>
  group_by(mu) |>
  summarize(proportion_rejected = sum(p.value < 0.05)/5000) |>
  ggplot(aes(x = mu, y = proportion_rejected)) +
  scale_x_continuous(limits = c(0, 6), breaks = seq(0, 6, 1)) + 
  geom_point() + 
  geom_line() +
  labs(x = "True Value of μ ", y = "Power of the Test", title = "Power of t-test vs. Different Means")
```

* From the plot, it can be seen that power increases as the effect size increases.

A plot showing the average estimate of `μ_hat`.
```{r}
result |>
  group_by(mu) |>
  summarize(average_estimate = mean(estimate)) |>
  ggplot(aes(x = mu, y = average_estimate)) +
  scale_x_continuous(limits = c(0, 6), breaks = seq(0, 6, 1)) + 
  geom_point() + 
  geom_line() +
  labs(x = "True μ", y = "Average Estimate μ_hat", title = "Average Estimate of μ_hat vs. True μ")
```

A plot showing the average estimate of `μ_hat` only in samples for which the null was rejected.